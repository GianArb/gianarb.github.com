<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Go how to cleanup HTTP request terminated.</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Cleaning up HTTP request, the most expensive one can be a huge performance improvement for your application. This short article shows how to handle HTTP request termination in Go.">
    <meta name="keywords" content="golang, go, http">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/go-http-cleanup-http-connection-terminated">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta property="twitter:account_id" content="129952408" />
    <meta name='twitter:title' content="Go how to cleanup HTTP request terminated." />
    <meta name='twitter:description' content="Cleaning up HTTP request, the most expensive one can be a huge performance improvement for your application. This short article shows how to handle HTTP request termination in Go." />
    <meta name="twitter:url" content="https://gianarb.it/blog/go-http-cleanup-http-connection-terminated" />
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:domain" content="gianarb.it">

    <meta property="og:title" content="Go how to cleanup HTTP request terminated." />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/go-http-cleanup-http-connection-terminated" />
    <meta property="og:description" content="Cleaning up HTTP request, the most expensive one can be a huge performance improvement for your application. This short article shows how to handle HTTP request termination in Go." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />


    <meta name="twitter:card" content="summary" />
    <meta property="og:image" content="https://gianarb.it/img/gopher.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/gopher.png" />


    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="navbar-brand" href="/">
            <a href="/" class="nav-link"><img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt=""></a>
        </div>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <ul class="navbar-nav ml-auto">
                <li><a class="nav-link" href="/">Home</a></li>
                <li><a class="nav-link" href="/blog.html">Blog</a></li>
                <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
                </li>
            </ul>

        </div> <!-- collapse -->

    </div> <!-- container fluild -->
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>Go how to cleanup HTTP request terminated.</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">25 Apr 2018 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Three minute read</span>
 · golang, go, http</p>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>Expensive HTTP handler is everywhere, doesn’t matter how good you are as a
developer. Business logic is what matters in our application, and it can be
pretty complicated. It can create large files, resources on AWS starts
thousands of containers on Kubernetes.</p>

<p>This kind of procedures have in common they can be very slow and they produce a
lot of garbage if the system/person who requires that stops prematurely by
mistake or not.</p>

<p>If your API requests create AWS resources and the client, terminate the call
you should clean what you created.</p>

<p>if you are generating a report and the customer changes are mind and refresh
you should stop the procedure.</p>

<p>You bet! Queues, background processes probably fit better but coming back on
the previous example, if you are computing something and who is waiting for the
result changed his mind, stop and release resources can be a massive
optimization.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package main

import <span class="o">(</span>
    <span class="s2">"fmt"</span>
    <span class="s2">"io/ioutil"</span>
    <span class="s2">"net/http"</span>
    <span class="s2">"os"</span>
    <span class="s2">"time"</span>
<span class="o">)</span>

func main<span class="o">()</span> <span class="o">{</span>
    http.HandleFunc<span class="o">(</span><span class="s2">"/a"</span>, func<span class="o">(</span>w http.ResponseWriter, r <span class="k">*</span>http.Request<span class="o">)</span> <span class="o">{</span>
        err :<span class="o">=</span> ioutil.WriteFile<span class="o">(</span>os.TempDir<span class="o">()</span>+<span class="s2">"/txt"</span>, <span class="o">[]</span>byte<span class="o">(</span><span class="s2">"hello"</span><span class="o">)</span>, 0644<span class="o">)</span>
        <span class="k">if </span>err <span class="o">!=</span> nil <span class="o">{</span>
            panic<span class="o">(</span>err<span class="o">)</span>
        <span class="o">}</span>
        println<span class="o">(</span><span class="s2">"new file "</span> + os.TempDir<span class="o">()</span> + <span class="s2">"/txt"</span><span class="o">)</span>
        notify :<span class="o">=</span> w.<span class="o">(</span>http.CloseNotifier<span class="o">)</span>.CloseNotify<span class="o">()</span>
        go func<span class="o">()</span> <span class="o">{</span>
            &lt;<span class="nt">-notify</span>
            println<span class="o">(</span><span class="s2">"The client closed the connection prematurely. Cleaning up."</span><span class="o">)</span>
            os.Remove<span class="o">(</span>os.TempDir<span class="o">()</span> + <span class="s2">"/txt"</span><span class="o">)</span>
        <span class="o">}()</span>
        time.Sleep<span class="o">(</span>4 <span class="k">*</span> time.Second<span class="o">)</span>
        fmt.Fprintln<span class="o">(</span>w, <span class="s2">"File persisted."</span><span class="o">)</span>
    <span class="o">})</span>
    http.ListenAndServe<span class="o">(</span><span class="s2">":8080"</span>, nil<span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When you are building an HTTP server in Go, you can use a channel provided by
the Zhttp.ResponseWriter` to wait for the connection to be closed. And if it
happens, you can take action.  The prototype above is very simple, every
request stores a file but I would like, remove the file if the client closes
the connection.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>run main.go
</code></pre></div></div>

<p>You can start the server, and from another terminal, you can start a <code class="highlighter-rouge">curl</code>, you
will see that after almost 4 seconds your request will succeed and the file
will be persisted on disk. Check it!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ time curl http://localhost:8080/a
File persisted.

real    0m4.018s
user    0m0.008s
sys     0m0.006s
$ cat /tmp/txt
</code></pre></div></div>

<p>Now let’s suppose that the client terminates the connection because it is too
slow or the person who made the request doesn’t care anymore.
Are you going to leave that request going? Event if nobody cares and it is just
consuming resources?</p>

<p>As you can see I am using the Notifier to remove the file if the client
terminates the connection:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">notify</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">w</span><span class="o">.</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">CloseNotifier</span><span class="p">)</span><span class="o">.</span><span class="n">CloseNotify</span><span class="p">()</span><span class="x">
</span><span class="k">go</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="o">&lt;-</span><span class="n">notify</span><span class="x">
    </span><span class="nb">println</span><span class="p">(</span><span class="s">"The client closed the connection prematurely. Cleaning up."</span><span class="p">)</span><span class="x">
    </span><span class="n">os</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">TempDir</span><span class="p">()</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"/txt"</span><span class="p">)</span><span class="x">
</span><span class="p">}()</span><span class="x">
</span></code></pre></div></div>

<p>You can check it stopping a <code class="highlighter-rouge">curl</code> just after starting it:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ time curl http://localhost:8080/a
^C

real    0m1.016s
user    0m0.008s
sys     0m0.005s
</code></pre></div></div>
<p>And the server reports</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ go run main.go
new file /tmp/txt
The client closed the connection prematurely. Cleaning up.
</code></pre></div></div>

<p>That’s it! Build and clean after yourself!</p>

            </div>
        </div>

    </div>
</div>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update July 12, 2021 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

    </body>
</html>
