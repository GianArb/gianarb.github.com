<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>How to do testing with zap a popular logging library for Golang</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="How you can use logging to build assertions when testing. What the popular Golang logging library provided by Uber gives you around unit tests.">
    <meta name="keywords" content="golang, mockmania, logging, zap">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/golang-mockmania-zap-logger">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta property="twitter:account_id" content="129952408" />
    <meta name='twitter:title' content="How to do testing with zap a popular logging library for Golang" />
    <meta name='twitter:description' content="How you can use logging to build assertions when testing. What the popular Golang logging library provided by Uber gives you around unit tests." />
    <meta name="twitter:url" content="https://gianarb.it/blog/golang-mockmania-zap-logger" />
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:domain" content="gianarb.it">

    <meta property="og:title" content="How to do testing with zap a popular logging library for Golang" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/golang-mockmania-zap-logger" />
    <meta property="og:description" content="How you can use logging to build assertions when testing. What the popular Golang logging library provided by Uber gives you around unit tests." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />


    <meta name="twitter:card" content="summary" />
    <meta property="og:image" content="https://gianarb.it/img/golang-mockmania.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/golang-mockmania.png" />


    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="navbar-brand" href="/">
            <a href="/" class="nav-link"><img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt=""></a>
        </div>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <ul class="navbar-nav ml-auto">
                <li><a class="nav-link" href="/">Home</a></li>
                <li><a class="nav-link" href="/blog.html">Blog</a></li>
                <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
                </li>
            </ul>

        </div> <!-- collapse -->

    </div> <!-- container fluild -->
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>How to do testing with zap a popular logging library for Golang</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">24 Mar 2020 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Four minute read</span>
 · golang, mockmania, logging, zap</p>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <div class="alert alert-dark" role="alert">
   <div class="row">
       <div class="col-md-2 align-self-center">
          <a href="https://link.testproject.io/0ak" target="_blank">
              <img class="img-fluid" src="/img/testproject-logo-small.png" />
          </a>
       </div>
       <div class="col-md-8 text-center">
           <a href="https://link.testproject.io/0ak" class="alert-link" target="_blank">TestProject</a> is a community all
           about testing and you know how much I love communities! Join us.
       </div>
   </div>
</div>

<p>If you follow me on <a href="https://twitter.com/gianarb">twitter</a> you know that
I am passionate about o11y, monitoring and code instrumentation.</p>

<p>I see logs not as a random print statement that you use only when something is
wrong, but they have value. Logs are the communication channel our applications
use. As developers it is our job to make them to speak in a comprehensive way.</p>

<p>Logs should be structured and in some way consistent across functions, http
handlers, applications even languages to simplify their use. From algorithms and
human operators.</p>

<p>In Go <a href="https://github.com/uber-go/zap">zap</a> is a popular logging library provided by Uber, I
use it almost by default for all my applications.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="s">"go.uber.org/zap"</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">logger</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">zap</span><span class="o">.</span><span class="n">NewProduction</span><span class="p">()</span><span class="x">
	</span><span class="n">do</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">do</span><span class="p">(</span><span class="n">logger</span><span class="x"> </span><span class="o">*</span><span class="n">zap</span><span class="o">.</span><span class="n">Logger</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">logger</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Start doing things"</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>So logging and testing? In the same article? I should be really drunk!</p>

<p class="text-center"><img src="/img/kermit-frog-drunk.jpg" alt="" class="img-fluid" /></p>

<p>When I discovered that <code class="highlighter-rouge">zap</code> comes with a testing utility package called
<code class="highlighter-rouge">zaptest</code> I felt in love with this library even more:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"testing"</span><span class="x">

	</span><span class="s">"go.uber.org/zap/zaptest"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">Test_do</span><span class="p">(</span><span class="n">t</span><span class="x"> </span><span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">logger</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">zaptest</span><span class="o">.</span><span class="n">NewLogger</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="x">
    </span><span class="n">do</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">go test</code> command supports the flag <code class="highlighter-rouge">-v</code> to improve verbosity of test
execution. In practice that’s how you forward to <code class="highlighter-rouge">stdout</code> logs and print
statements during a test execution. <code class="highlighter-rouge">zaptest</code> works with that as well.</p>

<p>Very cool, and useful if you write smoke tests, pipeline tests, or how ever you
call them and see the logs can be spammy, but helpful to figure out the actual
issue.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"testing"</span><span class="x">

	</span><span class="s">"go.uber.org/zap"</span><span class="x">
	</span><span class="s">"go.uber.org/zap/zapcore"</span><span class="x">
	</span><span class="s">"go.uber.org/zap/zaptest"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">Test_do</span><span class="p">(</span><span class="n">t</span><span class="x"> </span><span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">logger</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">zaptest</span><span class="o">.</span><span class="n">NewLogger</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="x"> </span><span class="n">zaptest</span><span class="o">.</span><span class="n">WrapOptions</span><span class="p">(</span><span class="n">zap</span><span class="o">.</span><span class="n">Hooks</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="n">zapcore</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">Level</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">zap</span><span class="o">.</span><span class="n">ErrorLevel</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Error should never happen!"</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">})))</span><span class="x">
	</span><span class="n">do</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>
<p>You can use <code class="highlighter-rouge">hooks</code> to check for expected or unexpected logs.</p>

<p>Hook are executed for every log line:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="n">zapcore</span><span class="o">.</span><span class="n">Entry</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">Level</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">zap</span><span class="o">.</span><span class="n">ErrorLevel</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Error should never happen!"</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">})</span><span class="x">
</span></code></pre></div></div>

<p>If you do not expect any error level log line for your execution because you are
testing the happy path, you can do something like that.</p>

<p><strong>DISCALIMER:</strong> This is another way to write assertion. You will may use them to enforce
other checks, or to validate the workflow from a different point of view that
will may be easier to do as first attempt. As I usually say: “an easy and
partial test is better than no test”.</p>

<p>Do not test only logs, it won’t age well! Keep writing good tests!</p>

            </div>
        </div>

    </div>
</div>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update July 12, 2021 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

    </body>
</html>
