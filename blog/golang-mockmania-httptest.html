<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-language" content="en">
    <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>The awesomeness of the httptest package in Go</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="One of the reasons why testing in Go is friendly is driven by the fact that the core team already provides useful testing package as part of the stdlib that you can use, as they do to test packages that depend on them. This article explains how to use the httptest package to mock HTTP servers and to test sdks that use the http.Client.">
    <meta name="keywords" content="golang, mockmania, http, httptest">
    <meta name="google-site-verification" content="FoOIQ005srOjHlH19pNWapHvlOOVgCqHsz47IfQ6QNo" />
    <link rel="canonical" href="https://gianarb.it/blog/golang-mockmania-httptest">
    <link rel="icon" type="image/png" href="/img/favicon.png" />

    <meta property="twitter:account_id" content="129952408" />
    <meta name='twitter:title' content="The awesomeness of the httptest package in Go" />
    <meta name='twitter:description' content="One of the reasons why testing in Go is friendly is driven by the fact that the core team already provides useful testing package as part of the stdlib that you can use, as they do to test packages that depend on them. This article explains how to use the httptest package to mock HTTP servers and to test sdks that use the http.Client." />
    <meta name="twitter:url" content="https://gianarb.it/blog/golang-mockmania-httptest" />
    <meta name="twitter:creator" content="@gianarb">
    <meta name="twitter:domain" content="gianarb.it">

    <meta property="og:title" content="The awesomeness of the httptest package in Go" />
    <meta property="og:site_name" content="gianarb blog"/>
    <meta property="og:url" content="https://gianarb.it/blog/golang-mockmania-httptest" />
    <meta property="og:description" content="One of the reasons why testing in Go is friendly is driven by the fact that the core team already provides useful testing package as part of the stdlib that you can use, as they do to test packages that depend on them. This article explains how to use the httptest package to mock HTTP servers and to test sdks that use the http.Client." />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />


    <meta name="twitter:card" content="summary" />
    <meta property="og:image" content="https://gianarb.it/img/golang-mockmania.png" />
    <meta name='twitter:image' content="https://gianarb.it/img/golang-mockmania.png" />


    <link rel='alternate' type='application/atom+xml' title='Atom 0.3' href='/atom.xml'>

    <!-- source https://github.com/rsms/inter/ -->
    <link href="/fonts/inter/inter-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">

</head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="navbar-brand" href="/">
            <a href="/" class="nav-link"><img src="/img/favicon.png" class="img-fluid d-inline-block align-top" alt=""></a>
        </div>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <ul class="navbar-nav ml-auto">
                <li><a class="nav-link" href="/">Home</a></li>
                <li><a class="nav-link" href="/blog.html">Blog</a></li>
                <li class="nav-item"><a href="/conferences.html" class="nav-link">Conferences</a></li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DLK7L&placement=gianarbit" id="_carbonads_js"></script>
                </li>
            </ul>

        </div> <!-- collapse -->

    </div> <!-- container fluild -->
</nav>

        

<div class="container">

    <div class="content">

        <div class="row">
            <div id="post-title" class="mt-5 col-md-12">
                <h1>The awesomeness of the httptest package in Go</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <p class="meta">25 Feb 2020 · <!-- thanks to https://www.davidputney.com/2016/07/how-medium-style-read-time-estimate.html -->


<span class="blog-read-time">Five minute read</span>
 · golang, mockmania, http, httptest</p>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
            <p>Go has a nice http package. I am able to say that because I am not aware of any
other implementation of it in Go other than the one provided by the standard
library. This is for me a good sign.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"http://example.com/"</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// handle error</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">defer</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>This example comes from the <a href="https://golang.org/pkg/net/http/">documentation</a>
itself.</p>

<p>We are here to read about testing, so who cares about the http package itself!
What matters is the <a href="https://golang.org/pkg/net/http/httptest/">httptest</a>
package! Way cooler.</p>

<p>This article is not the first one for the MockMania series, I wrote about titled
<a href="https://gianarb.it/blog/golang-mockmania-influxdb-v2-client">“InfluxDB Client
v2”</a>, it uses the
httptest service already! But hey it deserves its own blog post.</p>

<h2 id="server-side">Server Side</h2>

<p>The http package provides a client and a server. The server is made of handlers.
The handler takes a request and based on that it returns a response. This is its
interface:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">Handler</span><span class="x"> </span><span class="k">interface</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="o">*</span><span class="n">Request</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>As you can see if gets a ResponseWriter to compose a response based on the
Request it gets. This process can be as complicated as you like, it can reaches
databases, third party services but in the end, it writes a response.</p>

<p>It means that mocking all the dependencies to get the right scenario we use the
ResponseWriter to figure out if the handler made what we want.</p>

<p>The httptest package provides a replacement for the ResponseWriter called
ResponseRecorder. We can pass it to the handler and check how it looks like
after its execution:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">handler</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">io</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="x"> </span><span class="s">"ping"</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">req</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">httptest</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span><span class="x"> </span><span class="s">"http://example.com/foo"</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">)</span><span class="x">
</span><span class="n">w</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">httptest</span><span class="o">.</span><span class="n">NewRecorder</span><span class="p">()</span><span class="x">
</span><span class="n">handler</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="p">)</span><span class="x">

</span><span class="n">resp</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">w</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span><span class="x">
</span><span class="n">body</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">

</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">)</span><span class="x">
</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">body</span><span class="p">))</span><span class="x">
</span></code></pre></div></div>

<p>This handler is very simple, it just manipulates the response body. If your
handler is more complicated and it has dependencies you have to be sure to
replace them as well, injecting the appropriate one.</p>

<h2 id="client-side">Client-Side</h2>

<p>Handlers are useful if you can’t use them. The Go http package provides an http
client as well that you can use to interact with an http server. An http client
by itself is useless, but it is the entry point for all the manipulation and
transformation you do on the information you get via HTTP. With the
proliferation of microservices, it is a very common situation.</p>

<p>The workflow is well understood, you have an HTTP backend to interact with, you
fetch data from there are you manipulate them with your business logic. When
testing what you can do is to mock the http backend in order to return what you
want, testing that your business logic does what it is supposed to do based on
the input you get from the HTTP server.</p>

<p>During our first example, the handler was the subject of our testing, this is
not the case anymore, we are testing the consumer this time, so we have to mimic
and handler in order to get what we expect to return</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ts</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">httptest</span><span class="o">.</span><span class="n">NewServer</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Fprintln</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="x"> </span><span class="s">"I am a super server"</span><span class="p">)</span><span class="x">
</span><span class="p">}))</span><span class="x">
</span><span class="k">defer</span><span class="x"> </span><span class="n">ts</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
</span></code></pre></div></div>

<p>As you can see we are creating a new HTTP server via the httptest. It accepts a
handler. The goal for this handler returns what we would like to gest our code
on. In theory, it should just use the ResponseWriter to compose the response we
expect.</p>

<p>The server has a bunch of methods, the one you are looking for is the URL one.
Because we can pass it to an http.Client, the one we will use as a mock for our
function</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">URL</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="n">bb</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="x">
</span><span class="n">res</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
</span></code></pre></div></div>

<p>That’s it, as you can see <code class="highlighter-rouge">ts.URL</code> points the http.Client to the mock server we
created.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I use the httptest package a lot even when writing SDKs for services that do not
have integration with Go because I can follow their documentation mocking their
server and I do not need to reach them until I am confident with the code I
wrote.</p>

<p>My suggestion is to test your client code for edge cases as well because of the
httptest.Server gives you the flexibility to write any response you can think
about. You can mimic an authorized response to seeing how your code with handle
it, or an empty body or a rate limit. The only limit is our laziness.</p>

            </div>
        </div>

    </div>
</div>

        <div class="footer text-center bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-12 small">
                last update July 12, 2021 ·
                <a href="https://twitter.com/gianarb" target="_blank">twitter.com/gianarb</a> ·
                <a href="https://github.com/gianarb" target="_blank">github.com/gianarb</a> ·
                <a href="/atom.xml">Atom</a>
            </div>
        </div>
    </div>
</div>

    </body>
</html>
